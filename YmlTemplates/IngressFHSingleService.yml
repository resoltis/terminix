AWSTemplateFormatVersion: '2010-09-09'
Description: # Service Name - ENV - Fargate CFT - Date
Parameters: 
  AlbListenerArn: #This will be static based on ECS Cluster
    Type: String
  VpcId:  #This will be static based on Account/Env 
    Type: String
  DockerImageUrl: #This will be surveyed
    Type: String
  TargetEnv: #this will be surveyed 
    Type: String
  ContainerName: #thisdwill be static based off project name in repo
    Type: String
  ContainerPort: #this will be surveyed
    Type: Number
    Default: 6379
  ClusterName: #this will be static based on Account/Env
    Type: String
  ContainerCPU: 
   type: Number
  ContainerMemory: 
   Type: Number
  LogRetention: #Static 7 
    Type: Number
    Default: 7
  Version: # This will be surveyed - default to 1
    Type: String
    Default: 1
  RulePriority: #This is something we need to talk about (Not surveyed though)
    Type: Number
  BusinessUnitTag: #Surveyed by user
    Type: String  
  CustomerTag: #Surveyed by User
    Type: String 
  EnvironmentTag: #Surveyed by User (Dev/Test/Prod/QA/UAT or Migration/Training/Prod)
    Type: String
  ManagedByTag: #This is your web portal's name and static
    Type: String
  ProductOwnerTag: #Surveyed by user
    Type: String
  ProvisionedTag: #This is your web portal's name and static
    Type: String
  Subnets: #This is static based off the VPC ID
    Type: CommaDelimitedList
  DesiredCount: #Surveyed by user - default is 2
    Type: Number
    Default: 2
  TrafficPort: # fills for both traffic ports
  type: Number
  CidrIp: # secuirty group ip
  type: String

Resources:
  ExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName:  #build this off Service Name + Fargate-Execution-Role
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
            Action: 'sts:AssumeRole'
      ManagedPolicyArns:
        - 'arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy'
      Tags: 
        - Key: BusinessUnit
          Value: !Ref BusinessUnitTag
        - Key: Customer
          Value: !Ref CustomerTag
        - Key: Environment
          Value: !Ref EnvironmentTag
        - Key: ManagedBy
          Value: !Ref ManagedByTag
        - Key: ProductOwner
          Value: !Ref ProductOwnerTag
        - Key: Provisioned
          Value: !Ref ProvisionedTag
  TaskDefinition:
    Type: AWS::ECS::TaskDefinition
    Properties:
      Tags: 
        - Key: BusinessUnit
          Value: !Ref BusinessUnitTag
        - Key: Customer
          Value: !Ref CustomerTag
        - Key: Environment
          Value: !Ref EnvironmentTag
        - Key: ManagedBy
          Value: !Ref ManagedByTag
        - Key: ProductOwner
          Value: !Ref ProductOwnerTag
        - Key: Provisioned
          Value: !Ref ProvisionedTag
      ExecutionRoleArn: !Ref ExecutionRole
      TaskRoleArn: !Ref ExecutionRole
      Family: !Sub task-${AWS::StackName}
      NetworkMode: awsvpc
      RequiresCompatibilities: ['FARGATE']
      Cpu: !Ref ContainerCPU # SET THIS by Surveying User for a ContainerCPU param add it to the above parameter list and do !Ref ContainerCPU
      Memory: !Ref ContainerMemory # SET THIS by doing same as above but for ContainerMemory